name: Discord Release Notification

on:
  release:
    types: [published]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract Release Information
        id: release
        run: |
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "release_name=${{ github.event.release.name }}" >> $GITHUB_OUTPUT
          echo "release_url=${{ github.event.release.html_url }}" >> $GITHUB_OUTPUT

      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          RELEASE_BODY: ${{ github.event.release.body }}
          RELEASE_URL: ${{ steps.release.outputs.release_url }}
          RELEASE_TAG: ${{ steps.release.outputs.tag }}
        run: |
          set -e

          # Extract version from tag (remove 'v' prefix if present)
          VERSION="${RELEASE_TAG#v}"

          # Save release body to file to avoid shell escaping issues
          echo "$RELEASE_BODY" > release_body.txt

          # Truncate if too long (Discord limit is 4096, we use 3500 to be safe)
          BODY_LENGTH=$(wc -c < release_body.txt)
          if [ "$BODY_LENGTH" -gt 3500 ]; then
            head -c 3400 release_body.txt > release_body_truncated.txt
            echo "..." >> release_body_truncated.txt
            echo "" >> release_body_truncated.txt
            echo "[üìñ Read full release notes]($RELEASE_URL)" >> release_body_truncated.txt
            mv release_body_truncated.txt release_body.txt
          fi

          # Build description with header
          echo "**New version v$VERSION is now available!**" > description.txt
          echo "" >> description.txt
          echo "" >> description.txt
          cat release_body.txt >> description.txt

          # Create JSON payload using jq for proper escaping
          jq -n \
            --arg username "xZenith Releases" \
            --arg avatar "https://raw.githubusercontent.com/xFlawlessDev/xZenith-Releases/main/assets/xZenith-effect.png" \
            --arg title "üöÄ xZenith v$VERSION Released!" \
            --rawfile description description.txt \
            --arg url "$RELEASE_URL" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
            --arg discord_url "https://discord.gg/HKG9GNTesb" \
            '{
              "username": $username,
              "avatar_url": $avatar,
              "embeds": [{
                "title": $title,
                "description": $description,
                "url": $url,
                "color": 3447003,
                "thumbnail": {
                  "url": $avatar
                },
                "footer": {
                  "text": "xZenith - Unleash Peak Performance",
                  "icon_url": $avatar
                },
                "timestamp": $timestamp
              }],
              "components": [{
                "type": 1,
                "components": [
                  {
                    "type": 2,
                    "label": "Download Now",
                    "style": 5,
                    "url": $url,
                    "emoji": {
                      "name": "‚¨áÔ∏è"
                    }
                  },
                  {
                    "type": 2,
                    "label": "Join Discord",
                    "style": 5,
                    "url": $discord_url,
                    "emoji": {
                      "name": "üí¨"
                    }
                  }
                ]
              }]
            }' > payload.json

          # Send to Discord
          HTTP_CODE=$(curl -s -o response.txt -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "$DISCORD_WEBHOOK")

          if [ "$HTTP_CODE" -eq 204 ] || [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Discord notification sent successfully!"
          else
            echo "‚ùå Failed to send Discord notification"
            echo "HTTP Status: $HTTP_CODE"
            echo "Response:"
            cat response.txt
            exit 1
          fi
