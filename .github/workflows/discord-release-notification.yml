name: Discord Release Notification

on:
  release:
    types: [published]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract Release Information
        id: release
        run: |
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "release_name=${{ github.event.release.name }}" >> $GITHUB_OUTPUT
          echo "release_url=${{ github.event.release.html_url }}" >> $GITHUB_OUTPUT

      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Extract version from tag (remove 'v' prefix if present)
          VERSION="${{ steps.release.outputs.tag }}"
          VERSION="${VERSION#v}"

          # Get release body
          RELEASE_BODY='${{ github.event.release.body }}'

          # Truncate release body if too long (Discord embed description limit is 4096 chars)
          # We'll use a shorter limit to account for the header text
          MAX_LENGTH=3500
          if [ ${#RELEASE_BODY} -gt $MAX_LENGTH ]; then
            RELEASE_BODY="${RELEASE_BODY:0:$MAX_LENGTH}..."
            TRUNCATED=true
          else
            TRUNCATED=false
          fi

          # Build description with release notes
          if [ "$TRUNCATED" = true ]; then
            DESCRIPTION="**New version v$VERSION is now available!**\n\n$RELEASE_BODY\n\n[üìñ Read full release notes](${{ steps.release.outputs.release_url }})"
          else
            DESCRIPTION="**New version v$VERSION is now available!**\n\n$RELEASE_BODY"
          fi

          # Create JSON payload using jq for proper escaping
          jq -n \
            --arg username "xZenith Releases" \
            --arg avatar "https://raw.githubusercontent.com/xFlawlessDev/xZenith-Releases/main/assets/xZenith-effect.png" \
            --arg title "üöÄ xZenith v$VERSION Released!" \
            --arg description "$DESCRIPTION" \
            --arg url "${{ steps.release.outputs.release_url }}" \
            --arg version "$VERSION" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
            --arg discord_url "https://discord.gg/HKG9GNTesb" \
            '{
              "username": $username,
              "avatar_url": $avatar,
              "embeds": [{
                "title": $title,
                "description": $description,
                "url": $url,
                "color": 3447003,
                "thumbnail": {
                  "url": $avatar
                },
                "footer": {
                  "text": "xZenith - Unleash Peak Performance",
                  "icon_url": $avatar
                },
                "timestamp": $timestamp
              }],
              "components": [{
                "type": 1,
                "components": [
                  {
                    "type": 2,
                    "label": "Download Now",
                    "style": 5,
                    "url": $url,
                    "emoji": {
                      "name": "‚¨áÔ∏è"
                    }
                  },
                  {
                    "type": 2,
                    "label": "Join Discord",
                    "style": 5,
                    "url": $discord_url,
                    "emoji": {
                      "name": "üí¨"
                    }
                  }
                ]
              }]
            }' > payload.json

          # Send to Discord
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "Content-Type: application/json" -d @payload.json "$DISCORD_WEBHOOK")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          if [ "$HTTP_CODE" -eq 204 ] || [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Discord notification sent successfully!"
          else
            echo "‚ùå Failed to send Discord notification"
            echo "HTTP Status: $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi
